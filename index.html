<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/font-awesome.css">
</head>
<body>

<div class="container">

    <div class="alert alert-warning alert-window-too-small">
      <strong>Warning!</strong> Your web browser window is too narrow.
    </div>

    <div id="play">
	    <p class="text-center"><button class="btn btn-primary" id="playJack">Play as Jack</button></p>
	    <p class="text-center"><button class="btn btn-danger" id="playPolice">Play as Police</button></p>
	</div>

	<div id="jackSetBase">
		<p>Set Jack's Base.</p>
	</div>

	<div id="jackSetWretched">
		<p>Place <span id="womenMarked"></span> marked women tokens and then <span id="womenFake"></span> unmaked women tokens.</p>
	</div>

	<div id="policeSet">
		<p>Place <span id="policeMarked"></span> marked police tokens and then <span id="policeFake"></span> unmaked police tokens.</p>
	</div>

	<div id="jackWaitOrKill">
		<p>Check a police token or murder a wretched token.</p>
	</div>



    <div class="map">
		<div class="well well-sm move-tracker" id="moveTracker"></div>
        <img src="images/vintage-map.jpg" class="vintage-map">
        <object data="svg/streets-generated.svg" type="image/svg+xml" class="map-svg" />
    </div>

</div>

<script type="text/template" class="template">
<ul>
	<% _.each(_.range(-5, 15), function(num){ %>
		<span class="label label-primary tracker <% if (num == time) { %>active<% } %>"><%- num + 1 %></span>
	<% }) %>
</ul>
</script>

<script type="text/javascript" src="js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="js/underscore-min.js"></script>
<script type="text/javascript" src="js/backbone-min.js"></script>
<script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/map.js" type="text/javascript"></script>
<script type="text/javascript" src="js/script.js" type="text/javascript"></script>
<script type="text/javascript" src="js/draw.js" type="text/javascript"></script>

<script type="text/javascript">

function disableClicks(removeClasses){
	$('.map .label').off().removeClass(removeClasses)
}

function updateTime(){
	_.templateSettings.variable = 'time'
	let template = _.template($('script.template').html())
	$('#moveTracker').empty()
	$('#moveTracker').prepend(template(jack.get('time')))
}

function wait(){
	jack.wait()
	updateTime()
}

function suspenseGrows(){
	disableClicks('token token-woman token-woman-selected token-woman-selected-real token-police selectable')
	jackMurder()
	if (jack.get('time') > -5) {
		policeCheck()
	}
}

function jackMurder(){
	if (!jack.setMurder()){
		_.each(jack.get('wretchedTokens'), function(num, key){
			$('.location-' + num.id).click(function(){
				jack.murderWretched(_.findIndex(jack.get('wretchedTokens'), {id: num.id}))
				$(this).off().addClass('token-murder').removeClass('token-woman selectable')
				suspenseGrows()
			}).addClass('token token-woman selectable')
		})
	} else {
		console.log('Jack has finished murdering')
	}
}

function policeCheck(){
	_.each(squad.findWhere({lead: true}).get('policeTokens'), function(num, key){
		if (!(num.maked == false && num.checked == true)) {
			$('.location-' + num.id).click(function(){
				squad.findWhere({lead: true}).checkPolice(
					_.findIndex(squad.findWhere({lead: true}).get('policeTokens'), {id: num.id})
				)
				wait()
				jack.moveAllWretched()
				suspenseGrows()
			}).addClass('token token-police selectable')
		}
	})
}

function jackSetWomen(womenCount, womenMarked){
	$('#womenMarked').text(womenMarked)
	$('#womenFake').text(womenCount - womenMarked)
	_.each(map.key('murder'), function(num, key){
		$('.location-' + num).click(function(){
			let womenTokens = jack.get('womenTokens').length
			jack.setToken(key, womenTokens < womenMarked, 'womenTokens', 'murder')
			let selectedClass = (womenTokens < womenMarked) ? 'token-woman-selected-real' : 'token-woman-selected'
			$(this).off().addClass(selectedClass).removeClass('selectable')
			if (womenTokens >= womenCount - 1) {
				squad.findWhere({lead: true}).setPolice()
				jack.setWretched()
				suspenseGrows()
			}
		}).addClass('token token-woman selectable')
	})
}

function policeSet(policeCount, policeMarked){
	$('#policeMarked').text(policeMarked)
	$('#policeFake').text(policeCount - policeMarked)
	_.each(map.key('station'), function(num, key){
		$('.location-' + num).click(function(){
			let policeTokens = squad.findWhere({lead: true}).get('policeTokens').length
			squad.findWhere({lead: true}).setToken(key, policeTokens < policeMarked, 'policeTokens', 'police')
			let selectedClass = (policeTokens < policeMarked) ? 'token-police-selected-real' : 'token-police-selected'
			$(this).off().addClass(selectedClass).removeClass('selectable')
			if (policeTokens >= policeCount - 1) {
				jack.setWomen()
				// TODO: Next step
			}
		}).addClass('token token-police selectable')
	})
}

function jackSetBase(){
	$('.location-number').click(function(){
		jack.setBase($(this).data('mapid'))
		$(this).addClass('token-base')
		disableClicks('token selectable')
		jackSetWomen(jack.get('womenCount'), jack.get('womenMarked'))
	}).addClass('token selectable')
}

function play(isJack){
	window.jack = new Jack({'auto': !isJack})
	window.squad = new Squad({'auto': isJack, 'lead': true})
	drawMap()
	if (!isJack) {
		jack.randomBase()
		policeSet(squad.findWhere({lead: true}).get('policeCount'), squad.findWhere({lead: true}).get('policeMarked'))
	} else {
		jackSetBase()
	}
	updateTime()
}
$('#playJack').click(function(){
	play(true)
})
$('#playPolice').click(function(){
	play(false)
})

</script>

</body>
</html>